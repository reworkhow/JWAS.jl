<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Streaming Genotype Backend (BayesC MVP) · JWAS.jl</title><meta name="title" content="Streaming Genotype Backend (BayesC MVP) · JWAS.jl"/><meta property="og:title" content="Streaming Genotype Backend (BayesC MVP) · JWAS.jl"/><meta property="twitter:title" content="Streaming Genotype Backend (BayesC MVP) · JWAS.jl"/><meta name="description" content="Documentation for JWAS.jl."/><meta property="og:description" content="Documentation for JWAS.jl."/><meta property="twitter:description" content="Documentation for JWAS.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="JWAS.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">JWAS.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../theory/theory/">Some Theory</a></li><li><a class="tocitem" href="../../citing/citing/">Citing</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../getstarted/">Get Started</a></li><li><a class="tocitem" href="../workflow/">Workflow</a></li><li><a class="tocitem" href="../block_bayesc/">Block BayesC</a></li><li><a class="tocitem" href="../memory_usage/">Memory Usage</a></li><li><a class="tocitem" href="../streaming_genotype_walkthrough/">Streaming Genotype Walkthrough</a></li><li><a class="tocitem" href="../public/">Public</a></li><li><a class="tocitem" href="../internals/">Internals</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Examples</a></li></ul></li><li><a class="tocitem" href="../../FrequentlyAskedQuestions/FrequentlyAskedQuestions/">Frequently Asked Questions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Streaming Genotype Backend (BayesC MVP)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Streaming Genotype Backend (BayesC MVP)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/reworkhow/JWAS.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/reworkhow/JWAS.jl/blob/master/docs/src/manual/streaming_genotype_backend.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Streaming-Genotype-Backend-(BayesC-MVP)"><a class="docs-heading-anchor" href="#Streaming-Genotype-Backend-(BayesC-MVP)">Streaming Genotype Backend (BayesC MVP)</a><a id="Streaming-Genotype-Backend-(BayesC-MVP)-1"></a><a class="docs-heading-anchor-permalink" href="#Streaming-Genotype-Backend-(BayesC-MVP)" title="Permalink"></a></h1><p>This page documents the new opt-in streaming genotype backend for large-data original BayesC in JWAS.</p><h2 id="Status-and-Design"><a class="docs-heading-anchor" href="#Status-and-Design">Status and Design</a><a id="Status-and-Design-1"></a><a class="docs-heading-anchor-permalink" href="#Status-and-Design" title="Permalink"></a></h2><ul><li>Dense loading remains the default and primary path.<ul><li><code>get_genotypes(...; storage=:dense)</code> (default)</li><li>Existing dense workflows are unchanged.</li></ul></li><li>Streaming loading is additive and opt-in.<ul><li><code>get_genotypes(...; storage=:stream)</code></li><li>Current status: experimental MVP for original BayesC.</li></ul></li></ul><h2 id="Supported-Scope-(MVP)"><a class="docs-heading-anchor" href="#Supported-Scope-(MVP)">Supported Scope (MVP)</a><a id="Supported-Scope-(MVP)-1"></a><a class="docs-heading-anchor-permalink" href="#Supported-Scope-(MVP)" title="Permalink"></a></h2><ul><li>Single-trait analysis only</li><li>Method: <code>BayesC</code> only</li><li><code>fast_blocks=false</code> only</li><li>Unit residual weights only</li><li><code>double_precision=false</code> only</li><li>Complete genomic data only (no single-step)</li><li>Exact genotype/phenotype ID match and order required</li><li><code>outputEBV</code> and <code>output_heritability</code> are disabled in MVP streaming mode</li></ul><h2 id="Public-API"><a class="docs-heading-anchor" href="#Public-API">Public API</a><a id="Public-API-1"></a><a class="docs-heading-anchor-permalink" href="#Public-API" title="Permalink"></a></h2><h3 id="prepare_streaming_genotypes(...)"><a class="docs-heading-anchor" href="#prepare_streaming_genotypes(...)"><code>prepare_streaming_genotypes(...)</code></a><a id="prepare_streaming_genotypes(...)-1"></a><a class="docs-heading-anchor-permalink" href="#prepare_streaming_genotypes(...)" title="Permalink"></a></h3><p>One-time converter from text genotype file to packed marker-major 2-bit files.</p><pre><code class="language-julia hljs">prefix = prepare_streaming_genotypes(
    &quot;genotypes.csv&quot;;
    output_prefix = &quot;genotypes_stream&quot;,
    separator = &#39;,&#39;,
    header = true,
    missing_value = 9.0,
    quality_control = true,
    MAF = 0.01,
    center = true,
    conversion_mode = :lowmem,   # :lowmem | :dense | :auto
    auto_dense_max_bytes = 2^30, # used only when conversion_mode=:auto
    tmpdir = nothing,          # optional temp workspace for conversion spool
    cleanup_temp = true,       # remove temporary conversion files after success
    disk_guard_ratio = 0.9,    # fail fast if required bytes exceed ratio * free bytes
)</code></pre><p>Output artifacts with the chosen <code>prefix</code>:</p><ul><li><code>prefix.jgb2</code>: packed genotype payload (2-bit marker-major)</li><li><code>prefix.meta</code>: metadata manifest</li><li><code>prefix.obsid.txt</code>: individual IDs</li><li><code>prefix.markerid.txt</code>: marker IDs (after QC)</li><li><code>prefix.mean.f32</code>: per-marker means</li><li><code>prefix.xpRinvx.f32</code>: per-marker <code>x&#39;x</code> for unit-weight BayesC path</li><li><code>prefix.afreq.f32</code>: per-marker allele frequencies</li></ul><p>Conversion notes:</p><ul><li><code>conversion_mode=:lowmem</code> keeps conversion out-of-core (default).</li><li><code>conversion_mode=:dense</code> uses an in-memory dense conversion path (faster for small files, not RAM-safe for large files).</li><li><code>conversion_mode=:auto</code> chooses <code>:dense</code> when estimated dense bytes (<code>N*P*4</code>) fit under <code>auto_dense_max_bytes</code>; otherwise uses <code>:lowmem</code>.</li><li>In low-memory mode, conversion performs a staged write path with temporary row-major spool + transpose.</li><li>Temporary disk can approach one extra packed payload in low-memory mode; for very large <code>N, P</code>, place <code>tmpdir</code> on a high-capacity filesystem.</li></ul><h3 id="How-to-use-conversion_mode"><a class="docs-heading-anchor" href="#How-to-use-conversion_mode">How to use <code>conversion_mode</code></a><a id="How-to-use-conversion_mode-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-use-conversion_mode" title="Permalink"></a></h3><p>Use one of these patterns:</p><pre><code class="language-julia hljs"># 1) Large files (safest): always low-memory conversion
prefix = prepare_streaming_genotypes(&quot;genotypes.csv&quot;;
                                     conversion_mode=:lowmem,
                                     tmpdir=&quot;/scratch/jwas_tmp&quot;)

# 2) Small files (fast path): force dense in-memory conversion
prefix = prepare_streaming_genotypes(&quot;genotypes.csv&quot;;
                                     conversion_mode=:dense)

# 3) Hybrid default: auto-select dense for small jobs, lowmem otherwise
prefix = prepare_streaming_genotypes(&quot;genotypes.csv&quot;;
                                     conversion_mode=:auto,
                                     auto_dense_max_bytes=2^30) # 1 GiB threshold</code></pre><p>Practical rule: start with <code>conversion_mode=:auto</code>; use <code>:lowmem</code> explicitly for very large jobs or constrained RAM environments.</p><h3 id="get_genotypes(...;-storage:stream)"><a class="docs-heading-anchor" href="#get_genotypes(...;-storage:stream)"><code>get_genotypes(...; storage=:stream)</code></a><a id="get_genotypes(...;-storage:stream)-1"></a><a class="docs-heading-anchor-permalink" href="#get_genotypes(...;-storage:stream)" title="Permalink"></a></h3><p>Load packed genotype backend without materializing dense <code>N x P</code> genotype matrix.</p><pre><code class="language-julia hljs">geno = get_genotypes(
    prefix,            # prefix or .meta/.jgb2 path
    1.0;
    method = &quot;BayesC&quot;,
    estimatePi = true,
    storage = :stream,
)</code></pre><p>Dense behavior is unchanged:</p><pre><code class="language-julia hljs">geno = get_genotypes(&quot;genotypes.csv&quot;, 1.0; method=&quot;BayesC&quot;)  # storage=:dense default</code></pre><h2 id="End-to-End-Example"><a class="docs-heading-anchor" href="#End-to-End-Example">End-to-End Example</a><a id="End-to-End-Example-1"></a><a class="docs-heading-anchor-permalink" href="#End-to-End-Example" title="Permalink"></a></h2><pre><code class="language-julia hljs">using JWAS, CSV, DataFrames

phenotypes = CSV.read(&quot;phenotypes.csv&quot;, DataFrame)

# one-time conversion
prefix = prepare_streaming_genotypes(&quot;genotypes.csv&quot;;
                                     separator=&#39;,&#39;,
                                     header=true,
                                     quality_control=true,
                                     center=true)

# streaming load
global geno = get_genotypes(prefix, 1.0;
                            method=&quot;BayesC&quot;,
                            estimatePi=true,
                            storage=:stream)

model = build_model(&quot;trait1 = intercept + geno&quot;, 1.0)

out = runMCMC(model, phenotypes;
              chain_length=500,
              burnin=100,
              output_samples_frequency=50,
              output_folder=&quot;results_stream&quot;,
              outputEBV=false,
              output_heritability=false,
              seed=314,
              memory_guard=:off)</code></pre><h2 id="Benchmark-Snapshot"><a class="docs-heading-anchor" href="#Benchmark-Snapshot">Benchmark Snapshot</a><a id="Benchmark-Snapshot-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmark-Snapshot" title="Permalink"></a></h2><p>All numbers below were measured on:</p><ul><li>Julia <code>1.11.7</code></li><li>Apple M1 (8 CPU threads available)</li><li>macOS arm64</li></ul><h3 id="1)-Correctness:-simulated_omics-dense-vs-stream"><a class="docs-heading-anchor" href="#1)-Correctness:-simulated_omics-dense-vs-stream">1) Correctness: <code>simulated_omics</code> dense vs stream</a><a id="1)-Correctness:-simulated_omics-dense-vs-stream-1"></a><a class="docs-heading-anchor-permalink" href="#1)-Correctness:-simulated_omics-dense-vs-stream" title="Permalink"></a></h3><p>Dataset:</p><ul><li><code>/src/4.Datasets/data/simulated_omics</code></li><li>3534 individuals</li><li>1000 SNPs (927 markers after QC)</li></ul><p>Same seed/settings, single-trait BayesC:</p><table><tr><th style="text-align: right">Metric</th><th style="text-align: right">Value</th></tr><tr><td style="text-align: right">Marker effects correlation</td><td style="text-align: right"><code>0.999999999978</code></td></tr><tr><td style="text-align: right">Marker max abs diff</td><td style="text-align: right"><code>1.10e-6</code></td></tr><tr><td style="text-align: right">Marker mean abs diff</td><td style="text-align: right"><code>1.65e-7</code></td></tr><tr><td style="text-align: right">Residual variance abs diff</td><td style="text-align: right"><code>4.29e-7</code></td></tr></table><p>Interpretation:</p><ul><li>Streaming and dense are numerically equivalent up to floating-point noise.</li></ul><h3 id="2)-Large-synthetic-benchmark-(N10,000,-P5,000)"><a class="docs-heading-anchor" href="#2)-Large-synthetic-benchmark-(N10,000,-P5,000)">2) Large synthetic benchmark (<code>N=10,000</code>, <code>P=5,000</code>)</a><a id="2)-Large-synthetic-benchmark-(N10,000,-P5,000)-1"></a><a class="docs-heading-anchor-permalink" href="#2)-Large-synthetic-benchmark-(N10,000,-P5,000)" title="Permalink"></a></h3><p>Synthetic CSV genotype file size: <code>~100 MB</code>.</p><p><code>runMCMC</code> benchmark (<code>chain_length=25</code>, <code>burnin=5</code>):</p><table><tr><th style="text-align: right">Mode</th><th style="text-align: right">Real Time</th><th style="text-align: right">Max RSS</th><th style="text-align: right">Peak footprint</th></tr><tr><td style="text-align: right">Dense (load + run)</td><td style="text-align: right"><code>24.19s</code></td><td style="text-align: right"><code>1.396 GB</code></td><td style="text-align: right"><code>1.352 GB</code></td></tr><tr><td style="text-align: right">Stream run (after prepare)</td><td style="text-align: right"><code>20.70s</code></td><td style="text-align: right"><code>0.931 GB</code></td><td style="text-align: right"><code>0.727 GB</code></td></tr><tr><td style="text-align: right">Stream prepare (one-time)</td><td style="text-align: right"><code>11.99s</code></td><td style="text-align: right"><code>1.367 GB</code></td><td style="text-align: right"><code>1.144 GB</code></td></tr></table><p>Interpretation:</p><ul><li>Streaming reduced run-time memory significantly in this benchmark.</li><li>Conversion has one-time cost and memory use.</li><li>Absolute times are hardware- and IO-dependent.</li></ul><h3 id="2b)-Conversion-phase-benchmark-(N10,000,-P5,000)"><a class="docs-heading-anchor" href="#2b)-Conversion-phase-benchmark-(N10,000,-P5,000)">2b) Conversion-phase benchmark (<code>N=10,000</code>, <code>P=5,000</code>)</a><a id="2b)-Conversion-phase-benchmark-(N10,000,-P5,000)-1"></a><a class="docs-heading-anchor-permalink" href="#2b)-Conversion-phase-benchmark-(N10,000,-P5,000)" title="Permalink"></a></h3><p>Measured with <code>/usr/bin/time -l</code>:</p><table><tr><th style="text-align: right">Step</th><th style="text-align: right">Real Time</th><th style="text-align: right">Max RSS</th></tr><tr><td style="text-align: right"><code>prepare_streaming_genotypes</code></td><td style="text-align: right"><code>~11.8s</code></td><td style="text-align: right"><code>~1.14 GB</code></td></tr></table><p>Backend sizes:</p><table><tr><th style="text-align: right">Artifact</th><th style="text-align: right">Size</th></tr><tr><td style="text-align: right">packed payload (<code>.jgb2</code>)</td><td style="text-align: right"><code>~12.5 MB</code></td></tr><tr><td style="text-align: right">temporary row-major spool (during conversion)</td><td style="text-align: right"><code>~12.5 MB</code></td></tr></table><p>Interpretation:</p><ul><li>Converter RAM stays bounded for this size and no dense matrix is materialized.</li><li>Conversion needs temporary disk in addition to final payload.</li></ul><h3 id="3)-Target-scale-feasibility-estimator-(N500,000,-P2,000,000)"><a class="docs-heading-anchor" href="#3)-Target-scale-feasibility-estimator-(N500,000,-P2,000,000)">3) Target-scale feasibility estimator (<code>N=500,000</code>, <code>P=2,000,000</code>)</a><a id="3)-Target-scale-feasibility-estimator-(N500,000,-P2,000,000)-1"></a><a class="docs-heading-anchor-permalink" href="#3)-Target-scale-feasibility-estimator-(N500,000,-P2,000,000)" title="Permalink"></a></h3><p>Using <code>estimate_marker_memory(...)</code>:</p><table><tr><th style="text-align: right">Path</th><th style="text-align: right">Estimated marker-path memory</th></tr><tr><td style="text-align: right">Dense (<code>storage=:dense</code>, Float32)</td><td style="text-align: right"><code>3.64 TiB</code></td></tr><tr><td style="text-align: right">Stream (<code>storage=:stream</code>, Float32)</td><td style="text-align: right"><code>17.29 MiB</code></td></tr></table><p>Interpretation:</p><ul><li>Dense original BayesC is generally infeasible at this scale on normal nodes.</li><li>Streaming is designed to keep marker working memory near <code>O(N+P)</code>.</li></ul><h2 id="Notes"><a class="docs-heading-anchor" href="#Notes">Notes</a><a id="Notes-1"></a><a class="docs-heading-anchor-permalink" href="#Notes" title="Permalink"></a></h2><ul><li>Streaming support for non-unit weights and <code>fast_blocks</code> is planned as follow-up work.</li><li>For algorithmic memory/speed derivations, see <a href="../large_genotype_data_streaming/">Handling Large Genotype Data Without Loading the Full Matrix into Memory</a>.</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Thursday 26 February 2026 22:07">Thursday 26 February 2026</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
